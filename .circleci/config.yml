version: 2.1

orbs:
  node: circleci/node@5.0.2

jobs:
  deploy-to-env:
    parameters:
      target_env:
        type: string
    docker:
      - image: cimg/node:18.17
    steps:
      - checkout
      - run:
          name: Install Salesforce CLI
          command: npm install --global sfdx-cli
      - run:
          name: JWT Auth
          command: |
            echo "$JWT_KEY" > server.key
            chmod 600 server.key
            sfdx auth:jwt:grant \
              --username "${SF_USERNAME_<< parameters.target_env >>}" \
              --jwtkeyfile server.key \
              --clientid "${SF_CONSUMER_KEY_<< parameters.target_env >>}" \
              --instanceurl "${SF_INSTANCEURL_<< parameters.target_env >>}"
      - run:
          name: Deploy to Salesforce
          command: |
            sfdx force:source:deploy -p force-app --checkonly
            sfdx force:source:deploy -p force-app --testlevel RunLocalTests

workflows:
  deploy-dev:
    jobs:
      - deploy-to-env:
          name: Deploy to Qa
          target_env: "QA"
          filters:
            branches:
              only: qa

  deploy-qa:
    jobs:
      - deploy-to-env:
          name: Deploy to UAT
          target_env: "UAT"
          filters:
            branches:
              only: uat

  deploy-prod:
    jobs:
      - deploy-to-env:
          name: Deploy to Prod
          target_env: "PROD"
          filters:
            branches:
              only: main
