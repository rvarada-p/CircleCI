version: 2.1

orbs:
  node: circleci/node@5.0.2

jobs:
  deploy-to-env:
    parameters:
      target_env:
        type: string
    docker:
      - image: cimg/node:18.17
    steps:
      - checkout

      # Install Salesforce CLI  
      - run:
          name: Install Salesforce CLI
          command: |
            sudo npm install -g @salesforce/cli
            echo 'export PATH=$(npm bin -g):$PATH' >> "$BASH_ENV"
            source "$BASH_ENV"
            sf --version
            sf plugins --core

      # Install sfdx-git-delta
      - run:
          name: Install sfdx-git-delta
          command: |
            npm install sfdx-git-delta --global
            echo 'export PATH=$(npm bin -g):$PATH' >> "$BASH_ENV"
            source "$BASH_ENV"

      # Prepare JWT key
      - run:
          name: Prepare JWT key
          command: |
            echo "$JWT_KEY_B64" | base64 -d > server.key
            chmod 600 server.key
            openssl rsa -in server.key -check -noout

      # Authenticate to Salesforce
      - run:
          name: JWT Auth
          command: |
            source "$BASH_ENV"
            sf org login jwt \
              --username "${SF_USERNAME_<< parameters.target_env >>}" \
              --jwt-key-file server.key \
              --client-id "${SF_CONSUMER_KEY_<< parameters.target_env >>}" \
              --instance-url "${SF_INSTANCEURL_<< parameters.target_env >>}" \
              --alias "ci-<< parameters.target_env >>" --set-default

      # Generate delta (only for PROD tags)
      - run:
          name: Generate Delta
          command: |
            if [ "<< parameters.target_env >>" = "PROD" ]; then
              git fetch --tags
              export PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^)
              export CURRENT_TAG=$(git describe --tags --abbrev=0)
              echo "Deploying changes from $PREVIOUS_TAG to $CURRENT_TAG"

              sgd --to "$CURRENT_TAG" --from "$PREVIOUS_TAG" --output .delta --source force-app
            fi

      # Validate Deployment
      - run:
          name: Validate (checkonly)
          command: |
            source "$BASH_ENV"
            if [ "<< parameters.target_env >>" = "PROD" ]; then
              TEST_LEVEL="RunAllTestsInOrg"
              SRC_DIR=".delta"
            else
              TEST_LEVEL="NoTestRun"
              SRC_DIR="force-app"
            fi
            sf project deploy start \
              --source-dir $SRC_DIR \
              --test-level $TEST_LEVEL \
              --dry-run

      # Deploy Changes
      - run:
          name: Deploy to Salesforce
          command: |
            source "$BASH_ENV"
            if [ "<< parameters.target_env >>" = "PROD" ]; then
              TEST_LEVEL="RunAllTestsInOrg"
              SRC_DIR=".delta"
            else
              TEST_LEVEL="NoTestRun"
              SRC_DIR="force-app"
            fi
            sf project deploy start \
              --source-dir $SRC_DIR \
              --test-level $TEST_LEVEL

workflows:
  deploy-qa:
    jobs:
      - deploy-to-env:
          name: Deploy to QA
          target_env: "QA"
          filters:
            branches:
              only: qa

  deploy-uat:
    jobs:
      - deploy-to-env:
          name: Deploy to UAT
          target_env: "UAT"
          filters:
            branches:
              only: uat

  deploy-prod:
    jobs:
      - deploy-to-env:
          name: Deploy to Prod
          target_env: "PROD"
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
