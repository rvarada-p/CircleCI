version: 2.1

# ------------------------------------------------------------
# PARAMETERS
# ------------------------------------------------------------
parameters:
  sf_env:
    type: string
    default: "PROD"
  sf_login_url:
    type: string
    default: "https://login.salesforce.com"
  sf_consumer_key:
    type: env_var_name
    default: "SF_CONSUMER_KEY"
  sf_username:
    type: env_var_name
    default: "SF_USERNAME"
  sf_jwt_key:
    type: env_var_name
    default: "SF_JWT_KEY"

# ------------------------------------------------------------
# JOBS
# ------------------------------------------------------------
jobs:
  # ---------- 1. Run Apex Tests ----------
  run_apex_tests:
    docker:
      - image: cimg/node:20.5
    steps:
      - checkout
      - run: npm install sfdx-cli --global
      - run:
          name: Authenticate to Salesforce
          command: |
            echo "$SF_JWT_KEY" > server.key
            sfdx auth:jwt:grant \
              --client-id $SF_CONSUMER_KEY \
              --jwt-key-file server.key \
              --username $SF_USERNAME \
              --instance-url $SF_LOGIN_URL \
              --set-default-dev-hub
      - run:
          name: Run Apex Tests
          command: |
            mkdir -p test-results
            sfdx force:apex:test:run \
              --resultformat junit \
              --codecoverage \
              --outputdir test-results \
              --wait 30
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results

  # ---------- 2. Deploy Metadata ----------
  deploy_salesforce:
    docker:
      - image: cimg/node:20.5
    steps:
      - checkout
      - run: npm install sfdx-cli --global
      - run:
          name: Authenticate to Salesforce
          command: |
            echo "$SF_JWT_KEY" > server.key
            sfdx auth:jwt:grant \
              --client-id $SF_CONSUMER_KEY \
              --jwt-key-file server.key \
              --username $SF_USERNAME \
              --instance-url $SF_LOGIN_URL
      - run:
          name: Deploy Latest Metadata
          command: |
            echo "Deploying latest metadata to Salesforce..."
            sfdx force:source:deploy -x manifest/package.xml -w 60 --verbose
      - run:
          name: Confirm Deployment Success
          command: |
            echo "Deployment completed successfully."

# ------------------------------------------------------------
# WORKFLOWS
# ------------------------------------------------------------
workflows:
  deploy-on-merge:
    jobs:
      - run_apex_tests:
          context: salesforce-context
      - deploy_salesforce:
          requires:
            - run_apex_tests
          context: salesforce-context
          concurrency:
            group: "salesforce-deploy-main"
            cancel_in_progress: true
          filters:
            branches:
              only:
                - main
